// vim:fdm=marker
// {{{ Cortex Plus Constants
var cpCONSTANTS = {
    /* Edit these URLs to point to your dice assets */
    tokenD4: "https://s3.amazonaws.com/files.d20.io/images/3908534/h8snbjLuxlVqawSzCsKs5A/thumb.png?1398993124",
    tokenD6: "https://s3.amazonaws.com/files.d20.io/images/3907733/MDN2yejuiQS52A-8NECVkg/thumb.png?1398988459",
    tokenD8: "https://s3.amazonaws.com/files.d20.io/images/3908533/K3qv6LrN-3Cs3kU1zFIHOg/thumb.png?1398993124",
    tokenD10: "https://s3.amazonaws.com/files.d20.io/images/3908531/ptUfuaVxrtPno1K8RG3X-A/thumb.png?1398993123",
    tokenD12: "https://s3.amazonaws.com/files.d20.io/images/3908532/SCvdCztxZaHmQxLzLotgag/thumb.png?1398993123",

    // The players who can control this handout are considered GMs
    gmlistHANDOUT : "GM-LIST",

    cortexCOMMAND : "!cortex",
    poolCOMMAND : "!pool",
    tokenCOMMAND : "!token",
    complicationCOMMAND : "!complication",
    assetCOMMAND : "!asset",

    // The Macros available to players
    poolMACROS: [{
        "name": "Pool:Roll",
        "action": "!pool roll",
        "istokenaction": false,
        "visibleto": "all",
        "_type": "macro",
    },
    {
        "name": "Add-To-Pool",
        "action": "!pool add @{selected|bar1} @{selected|token_name}",
        "istokenaction": true,
        "visibleto": "all",
        "_type": "macro",
    },
    {
        "name": "Pool:Undo",
        "action": "!pool undo",
        "istokenaction": false,
        "visibleto": "all",
        "_type": "macro",
    },
    {
        "name": "Pool:Clear",
        "action": "!pool clear",
        "istokenaction": false,
        "visibleto": "all",
        "_type": "macro",
    },
    {
        "name": "Pool:Show",
        "action": "!pool show",
        "istokenaction": false,
        "visibleto": "all",
        "_type": "macro",
    },
    {
        "name": "Pool:Add",
        "action": "!pool add ?{Die Value} ?{Name}",
        "istokenaction": false,
        "visibleto": "all",
        "_type": "macro",
    },
    {
        "name": "Token:Add",
        "action": "!token add generic ?{Die Value} ?{Name}",
        "istokenaction": false,
        "visibleto": "all",
        "_type": "macro",
    },
    {
        "name": "Complication:Add",
        "action": "!token add complication ?{Die Value} ?{Name}",
        "istokenaction": false,
        "visibleto": "all",
        "_type": "macro",
    },
    {
        "name": "Asset:Add",
        "action": "!token add asset ?{Die Value} ?{Name}",
        "istokenaction": false,
        "visibleto": "all",
        "_type": "macro",
    },
    {
        "name": "GM-Pool:Add",
        "action": "!token add asset ?{Die Value} ?{Name}",
        "istokenaction": false,
        "visibleto": "",
        "_type": "macro",
    },
    {
        "name": "GM-Pool:Show",
        "action": "!pool shows",
        "istokenaction": false,
        "visibleto": "",
        "_type": "macro",
    }],
};
// }}}
(function(){function r(S){this.resultList=[this];this.elm=null;if(typeof(S)=="undefined"){S="#000000"}if(typeof(S.validateHsl)=="function"){this.setHsl([S.h,S.s,S.l])}else{this.setColor(S)}}r.prototype.setColor=function(S){if(typeof(S)=="undefined"){return}if(typeof(S)=="object"){this.setHsl(S)}else{this.setHex(S)}};r.prototype.setHsl=function(S){this.h=S[0];this.s=S[1];this.l=S[2];this.validateHsl();return this};r.prototype.validateHsl=function(){this.h=this.h%360;if(this.h<0){this.h+=360}if(this.s<0){this.s=0}if(this.s>100){this.s=100}if(this.l<0){this.l=0}if(this.l>100){this.l=100}};r.prototype.setHex=function(T){if(T.substring(0,1)=="#"){T=T.substring(1)}var U=parseInt(T.substring(0,2),16);var V=parseInt(T.substring(2,4),16);var S=parseInt(T.substring(4,6),16);this.setRgb([U,V,S]);return this};r.prototype.setRgb=function(X){var U=X[0]/255;var V=X[1]/255;var Y=X[2]/255;var S=Math.max(U,V,Y);var W=Math.min(U,V,Y);this.h=(S+W)/2;this.s=this.h;this.l=this.h;if(S==W){this.h=0;this.s=0}else{var T=S-W;this.s=this.l>0.5?T/(2-S-W):T/(S+W);switch(S){case U:this.h=(V-Y)/T+(V<Y?6:0);break;case V:this.h=(Y-U)/T+2;break;case Y:this.h=(U-V)/T+4;break}this.h=this.h/6}this.h=360*this.h;this.s=100*this.s;this.l=100*this.l;return this};r.prototype.hue2rgb=function(U,S,T){if(T<0){T+=1}if(T>1){T-=1}if(T<1/6){return U+(S-U)*6*T}if(T<1/2){return S}if(T<2/3){return U+(S-U)*(2/3-T)*6}return U};r.prototype.getRgb=function(){this.validateHsl();var X=this.h/360;var Y=this.s/100;var Z=this.l/100;var V=Z;var W=Z;var S=Z;if(Y!=0){var U=Z<0.5?Z*(1+Y):Z+Y-Z*Y;var T=2*Z-U;V=this.hue2rgb(T,U,X+1/3);W=this.hue2rgb(T,U,X);S=this.hue2rgb(T,U,X-1/3)}return[Math.round(V*255),Math.round(W*255),Math.round(S*255)]};r.prototype.getHex=function(){var T=this.getRgb();var S=this.toHexByte(T[0]);S+=this.toHexByte(T[1]);S+=this.toHexByte(T[2]);return"#"+S.toUpperCase()};r.prototype.toHexByte=function(S){var T=S.toString(16);if(T.length<2){T="0"+T}return T};r.prototype.getHsl=function(){this.validateHsl();return[this.h,this.s,this.l]};r.prototype.multi=function(X,S,T,U,V,W,Y,aa,ac,ad){var ab=[].concat(this.resultList);this.resultList=[];for(var ae in ab){var af=ab[ae];af.workList=[];if(X=="rel"){r.prototype.spinSingle.call(af,"rel",S,T,U,V,W,Y,aa,ac,ad)}if(X=="abs"){r.prototype.spinSingle.call(af,"abs",S,T,U,V,W,Y,aa,ac,ad)}this.resultList=this.resultList.concat(af.workList)}if(this.resultList.length==0){return this}var Z=this.resultList[this.resultList.length-1];this.h=Z.h;this.s=Z.s;this.l=Z.l;return this};r.prototype.rel=function(V,W,T,S,U){return this.multi("rel",V,W,T,S,U)};r.prototype.abs=function(X,Y,T,S,U){var V=false;if(typeof(X)=="object"){if(typeof(X.validateHsl)=="function"){V=true}}else{if((""+X).substring(0,1)=="#"){V=true}if((""+X).length>4){V=true}}if(V){var W=new r(X);return this.multi("abs",W.h,W.s,W.l,Y,T)}else{return this.multi("abs",X,Y,T,S,U)}};r.prototype.spinSingle=function(Z,W,ac,Y,ae,af){var aa=(Z=="abs"?-1:0);if(typeof(W)=="undefined"){W=aa}if(typeof(ac)=="undefined"){ac=aa}if(typeof(Y)=="undefined"){Y=aa}if(typeof(W)=="undefined"){ae=12}var T=0;var X=0;var U=0;if(typeof(W)=="object"){T=W.length}if(typeof(ac)=="object"){X=ac.length}if(typeof(Y)=="object"){U=Y.length}if(typeof(ae)=="undefined"){ae=1;if(T>ae){ae=T}if(X>ae){ae=X}if(U>ae){ae=U}}if(typeof(af)=="undefined"){af=0}var ad=null;if(typeof(ae)=="object"){ad=ae;ae=ad.length}for(step=af;step<ae;step++){var S=new r(this);var ah=(ae==1?1:step/(ae-1));var ab;var V;var ag;if(T>0){ab=W[step%T]}else{ab=W*ah}if(X>0){V=ac[step%X]}else{V=ac*ah}if(U>0){ag=Y[step%U]}else{ag=Y*ah}if(Z=="rel"){S.h+=ab;S.s+=V;S.l+=ag}else{if(W==aa){S.h=this.h}else{if(T==0){S.h=this.calcLinearGradientStep(step,ae,this.h,W)}else{S.h=ab}}if(ac==aa){S.s=this.s}else{if(X==0){S.s=this.calcLinearGradientStep(step,ae,this.s,ac)}else{S.s=V}}if(Y==aa){S.l=this.l}else{if(U==0){S.l=this.calcLinearGradientStep(step,ae,this.l,Y)}else{S.l=ag}}}S.step=step;if(ad){S.elm=ad.eq(step)}this.workList[step]=S}};r.prototype.calcLinearGradientStep=function(W,X,V,U){var S=(W/(X-1));var T=V+((U-V)*S);return T};r.prototype.each=function(S){for(var T in this.resultList){S.call(this.resultList[T],this.resultList[T].elm)}};r.prototype.get=function(S){if(typeof(S)=="undefined"){S=0}return this.resultList[S]};r.prototype.isDark=function(){return(!this.isLight())};r.prototype.isLight=function(){var S=this.getRgb();var T=(0.299*S[0])+(0.587*S[1])+(0.114*S[2]);return(T>127)};var n=/%[sdj%]/g;var u=function(W){var T=Array.prototype.slice.call(arguments,0);var Y=T.length;if(typeof W!=="string"){var V=[];while(Y--){V.unshift(T[U].toString())}return V.join(" ")}var U=1;var X=String(W).replace(n,function(Z){if(Z==="%%"){return"%"}if(U>=T){return Z}switch(Z){case"%s":return String(T[U++]);case"%d":return Number(T[U++]);case"%j":return JSON.stringify(T[U++]);default:return Z}});var S;while(U++<Y){S=T[U];if(S===null||typeof S!=="object"){X=[X,S].join(" ")}else{X+=[X,S.toString()].join()}}return X};function D(S){while(S.length>0){S.pop()}}function l(S){var T=getObj("player",S);return T.get("color")}function d(S){var U=findObjs({_type:"handout",name:cpCONSTANTS.gmlistHANDOUT});if(U.length==0){log("utilGetGMList: no GM Handout found");c.error(S,"Missing GM Handout","The handout called "+cpCONSTANTS.gmlistHANDOUT+" is missing");return false}var T=U[0].get("controlledby");if(T.length==0){c.error(S,"No GMs Found","The handout called "+cpCONSTANTS.gmlistHANDOUT+" doesn't have any players assigned.")}return T.split(",")}function K(S){var T=d(S);return _.contains(T,S.playerid)}function p(U,T,S){this.headBG=U,this.headText=T,this.border=S}p.Error=new p("rgb(242, 222, 222)","rgb(169, 68, 66)","rgb(235, 204, 209)");p.Info=new p("rgb(217, 237, 247)","rgb(49, 112, 143)","rgb(188, 232, 241)");p.Warning=new p("rgb(252, 248, 227)","rgb(138, 109, 59)","rgb(250, 235, 204)");p.Success=new p("rgb(223, 240, 216)","rgb(60, 118, 61)","rgb(214, 233, 198)");function c(S){this.panelMarkup={outerDiv:"<div style=\"background-color: rgb(255, 255, 255); border-bottom-color: COLOR_BORDER; border-bottom-left-radius: 4px; border-bottom-right-radius: 4px; border-bottom-style: solid; border-bottom-width: 1px; border-image-outset: 0px; border-image-repeat: stretch; border-image-slice: 100%; border-image-source: none; border-image-width: 1; border-left-color: COLOR_BORDER; border-left-style: solid; border-left-width: 1px; border-right-color: COLOR_BORDER; border-right-style: solid; border-right-width: 1px; border-top-color: COLOR_BORDER; border-top-left-radius: 4px; border-top-right-radius: 4px; border-top-style: solid; border-top-width: 1px; -webkit-box-shadow: rgba(0, 0, 0, 0.0470588) 0px 1px 1px 0px; box-shadow: rgba(0, 0, 0, 0.0470588) 0px 1px 1px 0px; box-sizing: border-box; color: rgb(51, 51, 51); display: block; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; margin-bottom: 0px;\">",headDiv:"<div style=\"  background-color: COLOR_BG; border-bottom-color: COLOR_BORDER; border-bottom-style: solid; border-bottom-width: 1px; border-left-color: COLOR_BORDER; border-right-color: COLOR_BORDER; border-top-color: COLOR_BORDER; border-top-left-radius: 3px; border-top-right-radius: 3px; box-sizing: border-box; color: COLOR_HEAD; display: block; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; padding-bottom: 10px; padding-left: 15px; padding-right: 15px; padding-top: 10px;\"> ",h3:"<h3 style=\" box-sizing: border-box; color: COLOR_HEAD; display: block; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 16px; font-weight: 500; line-height: 17.600000381469727px; margin-bottom: 0px; margin-top: 0px;\"> ",contentDiv:"<div style=\" box-sizing: border-box; color: rgb(51, 51, 51); display: block; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; padding-bottom: 15px; padding-left: 15px; padding-right: 15px; padding-top: 15px;\">"};this.colors=S;this.format_colors=function(T){return T.replace(/COLOR_HEAD/g,this.colors.headText).replace(/COLOR_BORDER/g,this.colors.border).replace(/COLOR_BG/g,this.colors.headBG)};this.render=function(Z,V){var ab=this.format_colors(this.panelMarkup.outerDiv),T=this.format_colors(this.panelMarkup.headDiv),W=this.format_colors(this.panelMarkup.h3),U=this.panelMarkup.contentDiv,X="</div>",aa="</h3>",Y=ab;if(Z){Y+=T+W+Z+aa+X}if(V){Y+=U+V+X}Y+=X;return Y}}c.success=function(T,U,V){log("success: "+U+": "+V);var S=new c(p.Success).render(U,V);sendChat("","/direct "+S)};c.warning=function(T,U,V){log("warning: "+U+": "+V);var S=new c(p.Warning).render(U,V);sendChat("","/direct "+S)};c.info=function(T,U,V){log("info: "+U+": "+V);var S=new c(p.Info).render(U,V);sendChat("","/direct "+S)};c.error=function(T,U,V){log("error: "+U+": "+V);var S=new c(p.Error).render(U,V);sendChat("","/direct "+S)};c.player=function(V,X,Z){var Y=l(V.playerid),W=new r(Y),S=W.rel(0,0,[-20,30,40]),U=new p(S.get(1).getHex(),S.get(0).getHex(),S.get(2).getHex()),T=new c(U).render(X,Z);sendChat(V.who,"/direct "+T)};function C(S){var V="<ul>";var T=false;_.each(cpCONSTANTS.poolMACROS,function(X){var Y=findObjs({_type:"macro",name:X.name});if(Y.length==0){T=true;return}});var W=findObjs({_type:"handout",name:cpCONSTANTS.gmlistHANDOUT});if(W.length==0){V+=u("<li>Handout %s is missing</li>",cpCONSTANTS.gmlistHANDOUT)}var U=!T&&W.length!=0;if(U){V+="Everything looks ok!"}V+="</ul>";if(U){c.success(S,"Cortex Plus Engine",V)}else{c.error(S,"Cortex Plus Engine",V)}}function L(S){log("cortexCreateMacros");var U=d(S);if(!U){return}var T=U[0];_.each(cpCONSTANTS.poolMACROS,function(V){var W=findObjs({_type:"macro",name:V.name});if(W.length>0){log("macro: "+V.name+" exists");return}V._playerid=T;createObj("macro",V);log("macro: "+V.name+" created")})}function w(S){log("cortexGetMacros");var T=findObjs({_type:"macro"});log(T)}function i(S){log("cortexResetState");state.pools={};state.cmdStack={};state.tokens={};state.tokens.lookup={};state.tokens.groups={};c.success(S,"Cortex Plus Engine","Cortex Plus Engine has been reset")}function B(){if(!state.pools){state.pools={}}if(!state.cmdStack){state.cmdStack={}}}function h(S){if(!state.cmdStack[S]){state.cmdStack[S]=new Array()}return state.cmdStack[S]}function f(S,T){h(S).push(T);return T}function a(S){return h(S).pop()}function O(S){if(!state.pools[S]){state.pools[S]=[]}return state.pools[S]}function N(S){var T=O(S);D(T)}function s(S){return"d"+S.value+" "+S.label}function e(T){var S='<div data-origindex="0" class="diceroll dVALUE" style="display:block"><div class="dicon"><div class="didroll" style="font-weight: normal">VALUE</div><div class="backing"></div></div><span>LABEL</span></div>';if(T.label.length==0){T.label=" "}return S.replace(/VALUE/g,T.value).replace(/LABEL/g,T.label)}function k(S){if(S.label.length>0){return"1d"+S.value+"["+S.label+"]"}else{return"1d"+S.value}}function x(S,T){c.error(T,"Sorry, Command not understood")}function G(S,U){log("pool clear");var T=O(U.playerid).slice();N(U.playerid);R(U,"Your dice pool is now empty.");f(U.playerid,{type:"clear",pool:T,silent:U.silent})}function R(T,U,S){if(T.silent){sendChat("Dice Pool","/w "+T.who+" "+U+": "+(!S?" ":S))}else{c.player(T,U,S)}}function P(S,V){log("showPool");var U=O(V.playerid);if(U.length==0){R(V,"Your dice pool is empty.");return}var T=[];_.each(U,function(W){if(V.silent){T.push(s(W))}else{T.push(e(W))}});T=V.silent?T.join(", "):T.join("");R(V,"Your Dice Pool",T)}function m(S,T){log("addPool");var Z=S[0];var Y=Z.match(/^(?:([0-9]*)d)?([0-9]+|%)$/);if(!Y){R(T,"ERROR: This isn't a die: "+S[0]);return}log(Y);if(Y[1]!=null&&Y[1]>1){R(T,"ERROR: You can only add 1 dice (e.g, 1d4, not 2d4)");return}var X=Number(Y[2]);if(!X){R(T,"ERROR: This isn't valid: "+S[0]);return}S.shift();var U="";if(S.length>0){U=S.join(" ")}var W={label:U,value:X};var V=O(T.playerid);V.push(W);P(S,T);f(T.playerid,{type:"add",die:W,silent:T.silent})}function J(T,U){log("roll pool");var X=O(U.playerid);if(X.length==0){R(U,"Your dice pool is empty.");return}var V=2;if(T.length==1){V=Number(T[0])}var W=[];_.each(X,function(Z){W.push(k(Z))});var Y="/roll {"+W.join(" + ")+"}k"+V;var S="/roll {"+W.join(" + ")+"}k"+V;c.player(U,"Rolling...");sendChat(U.who,Y)}function F(S,T){var U=a(T.playerid);if(!U){c.player(T,"Nothing to Undo");return}switch(U.type){case"add":O(T.playerid).pop();T.silent=U.silent;P(S,T);break;case"clear":T.silent=U.silent;Array.prototype.push.apply(O(T.playerid),U.pool);P(S,T);break}}function v(){if(!state.tokens){state.tokens={};state.tokens.lookup={};state.tokens.groups={}}}function E(S,T){sendChat("Error","bad command.")}function z(S){switch(S){case 4:return cpCONSTANTS.tokenD4;case 6:return cpCONSTANTS.tokenD6;case 8:return cpCONSTANTS.tokenD8;case 10:return cpCONSTANTS.tokenD10;case 12:return cpCONSTANTS.tokenD12}return false}function b(T){var S=getObj("graphic",T);if(S===undefined){S=getObj("text",T)}if(S===undefined){log("ERROR: can't find object: "+T)}return S}function t(T){var S=T.join("-");log("new groupid: "+S);_.each(T,function(U){state.tokens.lookup[U]=S});state.tokens.groups[S]=T;return S}function A(){state.tokens.groups={};state.tokens.lookup={}}function H(S,T){log("tokenGroupDestroy");var U=state.tokens.groups[T];_.each(U,function(V){log("deleting: "+V);delete state.tokens.lookup[V]});log("deleting group: "+T);delete state.tokens.groups[T]}function o(V,T,S){log("tokenGroupMove");var U=state.tokens.groups[S];_.each(U,function(ab){if(ab==V.get("_id")){return}log("moving for: "+ab);var Y=b(ab);var X=T.left-Y.get("left");var W=T.top-Y.get("top");var aa=X<0?V.get("left")-X:V.get("left")+X;var Z=V.get("top")+W;Y.set("left",aa);Y.set("top",Z)})}function j(S){log("fetchAvatarForPlayer: "+S);var U=findObjs({_type:"character",controlledby:S});var T=null;_.each(U,function(V){T=findObjs({_pageid:Campaign().get("playerpageid"),_type:"graphic",represents:V("_id")})});T=_.reject(T,function(V){V==null});return T}function y(S,T){log("tokenFindNamedToken: "+S+", "+T);var U=findObjs({_pageid:Campaign().get("playerpageid"),_type:"graphic",controlledby:S,name:T});return U}function q(S,T){log("tokenCommandClearGroups");A()}function g(S,W){log("tokenCommandAdd");if(S.length<=2){c.error(W,"Token Error","Can't add token. Arguments are missing.");return}var V=S[0];var U=(V=="complication"||V=="asset");S.shift();var ae=S[0];ae=ae.match(/(?:\d+d)?(\d+)/);if(!ae){c.error(W,"Token Error","This isn't a die: "+S[0]);return}log("matched: "+ae[1]);ae=Number(ae[1]);S.shift();var aa="";if(S.length>0){aa=S.join(" ")}var X={label:aa,value:ae};var aj=z(X.value);if(!aj){c.error(W,"Token Error","Invalid dice value: "+X.value);return}if(X.label.length==0){c.error(W,"Token Error","Missing token name");return}var af=null;var ad=null;var T=null;if(!U){var ab=j(W.playerid);if(ab.length==0&&W.selected&&W.selected.length==0){c.error(W,"Token Error","You don't have a destination selected nor an avatar on the table.");return}var ag=null;if(ab.length==0){ag=getObj(W.selected[0]["_type"],W.selected[0]["_id"])}else{ag=ab[0]}af=ag.get("left");ad=ag.get("top")}else{if(V=="asset"){var ah=y(W.playerid,"assets");if(ah.length==0){c.error(W,"Token Error","Where is your Assets card?");return}T=ah[0]}else{if(V=="complication"){var ai=y(W.playerid,"complications");if(ai.length==0){c.error(W,"Token Error","Where is your Complications card?");return}T=ai[0]}}af=(T.get("left")-T.get("width")/2)+40+5;ad=(T.get("top")-T.get("height")/2)+40+20}var Y=createObj("graphic",{imgsrc:aj,pageid:Campaign().get("playerpageid"),layer:"objects",bar1_value:X.value,left:af,top:ad,width:40,height:40,controlledby:"all",name:X.label});var ac=createObj("text",{text:X.label,pageid:Campaign().get("playerpageid"),layer:"objects",font_size:18,font_family:"Patrick Hand",controlledby:"all",left:0,top:0});ac.set("left",af+40+20);ac.set("top",Y.get("top"));var Z=[Y.get("_id"),ac.get("_id")];t(Z)}var Q=function(S,T){log("processCommands: "+S);log("processCommands: "+T.who);var U=S.shift().toLowerCase();if(S[0]){S[0]=S[0].toLowerCase()}log("argv[0]: '"+S[0]+"'");T.silent=false;switch(U){case"!dim":var V=getObj(T.selected[0]["_type"],T.selected[0]["_id"]);log(V.get("width"),V.get("height"));break;case cpCONSTANTS.cortexCOMMAND:switch(S[0]){case"setup":if(K(T)){L(T)}case"reset":if(K(T)){i(T)}break}break;case cpCONSTANTS.poolCOMMAND:switch(S[0]){case"adds":T.silent=true;case"add":S.shift();m(S,T);break;case"clear":S.shift();G(S,T);break;case"shows":T.silent=true;case"show":S.shift();P(S,T);break;case"roll":S.shift();J(S,T);break;case"undo":F(S,T);break;default:x(S,T);break}break;case cpCONSTANTS.tokenCOMMAND:switch(S[0]){case"add":S.shift();g(S,T);break;case"cleargroups":if(K(T)){q(S,T)}break;default:E(S,T);break}break}};on("chat:message",function(U){var T=U.content;var S=T.split(" ");if(U.type!="api"){log("api message");return}return Q(S,U)});on("ready",function(){log("campaign ready");B();v()});function M(U,T){var S=state.tokens.lookup[U.get("_id")];log(S);log(state.tokens.lookup);return;if(S){o(U,T,S)}}function I(T){var S=state.tokens.lookup[T.get("_id")];log(S);log(state.tokens.lookup);if(S){H(T.get("_id"),S)}}on("change:text",function(T,S){log("change:text");M(T,S)});on("change:graphic",function(T,S){log("change:graphic");M(T,S)});on("destroy:text",function(S){log("destroy:text");I(S)});on("destroy:graphic",function(S){log("destroy:graphic");I(S)});(function(){var S=createObj;createObj=function(){var T=S.apply(this,arguments);if(T&&!T.fbpath){T.fbpath=T.changed._fbpath.replace(/([^\/]*\/){4}/,"/")}return T}}())}());